name: Branch Protection

on:
  push:
    branches: [development, main]
  pull_request:
    branches: [development, main]

jobs:
  validate:
    name: Validate Branch State
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for branch comparison

      - name: Check for local-only files
        run: |
          echo "Checking for accidentally committed local files..."

          # Check for prohibited files
          FOUND_ISSUES=0

          for file in CLAUDE.md MEMORY.md; do
            if git ls-files | grep -q "^$file$"; then
              echo "❌ ERROR: $file is tracked in git (should be local-only)"
              FOUND_ISSUES=1
            fi
          done

          # Check for prohibited directories
          for dir in _archive benchmark_results; do
            if git ls-files | grep -q "^$dir/"; then
              echo "❌ ERROR: $dir/ is tracked in git (should be local-only)"
              FOUND_ISSUES=1
            fi
          done

          if [ $FOUND_ISSUES -eq 0 ]; then
            echo "✅ No local-only files detected"
          else
            echo ""
            echo "Fix: Remove these files from git tracking"
            exit 1
          fi

      - name: Verify .gitattributes exists
        run: |
          if [ ! -f .gitattributes ]; then
            echo "❌ ERROR: .gitattributes not found"
            echo "This file is required for proper merge behavior"
            exit 1
          fi
          echo "✅ .gitattributes found"

      - name: Check for unauthorized docs
        run: |
          echo "Checking docs/ directory..."

          # Allowed public documentation files (main branch)
          ALLOWED_DOCS="ADVANCED_FEATURES_GUIDE.md|BENCHMARKS.md|claude_code_config.md|DOCUMENTATION_INDEX.md|GIT_WORKFLOW.md|HYBRID_SEARCH_CONFIGURATION_GUIDE.md|INSTALLATION_GUIDE.md|MCP_TOOLS_REFERENCE.md|MODEL_MIGRATION_GUIDE.md|PYTORCH_COMPATIBILITY.md|VERSION_HISTORY.md"

          # Find unauthorized docs (only check on main branch)
          if [ "$GITHUB_REF" = "refs/heads/main" ]; then
            UNAUTHORIZED=$(git ls-files docs/ | grep -v -E "docs/($ALLOWED_DOCS)$" || true)

            if [ -n "$UNAUTHORIZED" ]; then
              echo "❌ ERROR: Unauthorized documentation files found on main branch:"
              echo "$UNAUTHORIZED"
              echo ""
              echo "Only these 11 docs are allowed in main branch:"
              echo "$ALLOWED_DOCS" | tr '|' '\n'
              exit 1
            fi
          fi

          echo "✅ Documentation validation passed"

  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    needs: validate
    # Only run tests on development branch (main doesn't have tests/)
    if: github.ref == 'refs/heads/development'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[test]

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short --maxfail=5 --ignore=tests/slow_integration/
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 7

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install ruff black isort

      - name: Run ruff
        run: ruff check .
        continue-on-error: true

      - name: Check formatting
        run: black --check .
        continue-on-error: true

      - name: Check imports
        run: isort --check-only .
        continue-on-error: true

  merge-check:
    name: Merge Validation (Main Branch Only)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cleanup tests directory in main branch
        run: |
          if [ -d "tests" ] || [ -f "pytest.ini" ]; then
            echo "⚠️  Test files found in main branch (from merge)"
            echo "   Removing per .gitattributes policy..."

            # Remove tests/ and pytest.ini if they exist
            if [ -d "tests" ]; then
              rm -rf tests/
              echo "   ✓ Removed tests/ directory"
            fi
            if [ -f "pytest.ini" ]; then
              rm -f pytest.ini
              echo "   ✓ Removed pytest.ini"
            fi

            # Check if we're in a push event (not pull_request)
            if [ "${{ github.event_name }}" = "push" ]; then
              # Configure git
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

              # Commit and push the cleanup
              git add -A
              git commit -m "chore: Remove test files from main branch (automated cleanup)

Per repository policy, test files should only exist in development branch.
This is an automated cleanup triggered by merge from development."
              git push origin main

              echo "   ✓ Cleanup committed and pushed"
            else
              echo "   ℹ️  Pull request event - cleanup will happen on merge"
            fi
          else
            echo "✅ No test files in main (as expected)"
          fi

      - name: Report merge validation success
        run: |
          echo "✅ Main branch merge validation passed"
          echo "   - Test files cleaned up (if present)"
          echo "   - Branch protection policies enforced"
